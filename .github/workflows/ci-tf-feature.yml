name: CI / tf / feature

# feature-* ブランチへの push で起動（infra/** 変更時のみ）
# fmt / validate → plan(dev) → apply(dev)

on:
  push:
    branches:
      - "feature-*"
    paths:
      - "infra/**"
      - ".github/workflows/ci-tf-feature.yml"

jobs:

  tf-validate:
    name: tf fmt / validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9"
          terraform_wrapper: false
      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff .
      - name: Terraform Init (backend なし)
        run: terraform init -backend=false -input=false
      - name: Terraform Validate
        run: terraform validate

  tf-plan-dev:
    name: tf plan / dev
    needs: [tf-validate]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SA_EMAIL }}
          token_format: "access_token"
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9"
          terraform_wrapper: false
      - name: Terraform Init (dev)
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TFSTATE_BUCKET_DEV }}" \
            -reconfigure \
            -input=false
      - name: Terraform Plan (dev)
        run: |
          terraform plan \
            -var-file=config.tfvars \
            -var="env=dev" \
            -no-color \
            -input=false

  tf-apply-dev:
    name: tf apply / dev
    needs: [tf-plan-dev]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.TERRAFORM_SA_EMAIL }}
          token_format: "access_token"
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9"
          terraform_wrapper: false
      - name: Terraform Init (dev)
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TFSTATE_BUCKET_DEV }}" \
            -reconfigure \
            -input=false
      - name: Terraform Apply (dev)
        run: |
          terraform apply \
            -var-file=config.tfvars \
            -var="env=dev" \
            -auto-approve \
            -input=false
